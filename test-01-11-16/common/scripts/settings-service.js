/*
Unpublished work.
Copyright (c) 2014-2015 by Teradata Corporation. All rights reserved.
TERADATA CORPORATION CONFIDENTIAL AND TRADE SECRET
*/

(function(D,E){D.Terradata=D.Terradata||{};var F=D.Terradata,A=D.Class,C=F.Slider,B=F.Multiselect;F.SettingsService=A.extend({initialize:function(G){this._graph=G.graph;this._settings={};this._initialConfiguration=[];if(this._graph.getNodes){this._setupCustomNodePositionSettings()}$(D).on("message",this._onMessage.bind(this));var H=this;$(D).bind("beforeunload",function(){return })},register:function(H,J,I){var G=this._settings[H.id||H.attr("id")||H.attr("name")]={};G.state=H;if(J&&I){G.save=J;G.load=I}this._addToInitialConfig(H)},registerCustomNodePosition:function(H){var I="custom-node-position",G=this._settings[I];G.state.value[H.id]={id:H.id,x:H.x,y:H.y}},save:function(){this._initialConfiguration.length=0;var G=_.map(_.values(this._settings),function(H){var I=H.state,J=I.id||I.attr("id")||I.attr("name");this._addToInitialConfig(H.state);if(I instanceof B){return{id:J,value:I.getSelected()}}else{if(I instanceof C){return{id:J,value:I.value()}}else{return{id:J,value:this._settings[J].save(I)}}}},this);D.parent.postMessage({type:"save-configuration",data:G},"*");return G},load:function(G){this.isLoading=true;if(this._graph.getNodes){_.each(this._graph.getNodes(),function(H){H.x=H.originalX;H.y=H.originalY})}this._initialConfiguration.length=0;_.each(_.values(this._settings),function(H){var J=H.state.id||H.state.attr("id")||H.state.attr("name"),I=_.findWhere(G,{id:J});if(I){if(H.state instanceof B){H.state.select(I.value,true)}else{if(H.state instanceof C){H.state.value(I.value,true)}else{this._settings[J].load(H.state,I)}}this._addToInitialConfig(H.state)}else{console.log("no preset found for",J,H.state)}},this);this._graph.refresh();this.isLoading=false},isStateModified:function(){var G=_.map(_.values(this._settings),function(H){var I=H.state,J=I.id||I.attr("id")||I.attr("name");if(I instanceof B){return{id:J,value:I.getSelected()}}else{if(I instanceof C){return{id:J,value:I.value()}}else{return{id:J,value:this._settings[J].save(I)}}}},this);console.log(!_.isEqual(G,this._initialConfiguration));return !_.isEqual(G,this._initialConfiguration)},_addToInitialConfig:function(I){var J=I.id||I.attr("id")||I.attr("name");var H=this;var G=function(){if(I instanceof B){return{id:J,value:_.clone(I.getUnInitialize())}}else{if(I instanceof C){return{id:J,value:I.value()}}else{return{id:J,value:_.clone(H._settings[J].save(I))}}}};this._initialConfiguration.push(G())},_onMessage:function(G){var H=G.originalEvent.data;if(H.type==="save-configuration"){this.save()}else{if(H.type==="load-configuration"){this.load(H.data)}}},_setupCustomNodePositionSettings:function(){var J="custom-node-position",H=this._graph,G,I;G=this._settings[J]={};G.state={};G.state.value={};G.state.id=J;G.save=function(K){return K.value};G.load=function(L,K){_.each(_.values(K.value),function(N){var M=H.getNodes(N.id);M.x=N.x;M.y=N.y},this);this.state.value=K.value};this._initialConfiguration.push({id:J,value:{}})}})})(window);
